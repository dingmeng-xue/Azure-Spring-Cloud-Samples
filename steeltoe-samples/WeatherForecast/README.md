# Overall
This sample bases WeatherForecast sample project from [Steeltoe](https://steeltoe.io/). It demonstrates how user deploys app and how to enable Service Registry.

# Prerequisite
* [.NET 6.0](https://dotnet.microsoft.com/en-us/download/dotnet) 
* [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest) or [Azure Cloud Shell](https://docs.microsoft.com/azure/cloud-shell/overview)

## Provision your Azure Spring Apps service instance

Please reference doc to provision Azure Spring Apps service instance: https://learn.microsoft.com/azure/spring-apps/quickstart

Create environment variables file `setup-env-variables.sh` based on template. 
```bash
cp ../setup-env-variables-template.sh setup-env-variables.sh
```

Update below resource information in `setup-env-variables.sh`.
```bash
export SUBSCRIPTION='subscription-id'                 # replace it with your subscription-id
export RESOURCE_GROUP='resource-group-name'           # existing resource group or one that will be created in next steps
export SPRING_APPS_SERVICE='azure-spring-apps-name'   # name of the service that will be created in the next steps
```

```bash
# Load variables 
source ./setup-env-variables.sh

# Select target subscription
az account set --subscription ${SUBSCRIPTION}
```

# Get Started
## For local development
```bash
dotnet run
```

## Enterprise pricing plan
```bash
# Add repository to Application Configuration Service
az spring application-configuration-service git repo add -g ${RESOURCE_GROUP} -s ${SPRING_APPS_SERVICE} --name weatherforecast --uri https://github.com/dingmeng-xue/Azure-Spring-Cloud-Samples --label main --patterns weatherforecast --search-paths springboot-samples/config

# Create application
az spring app create -g ${RESOURCE_GROUP} -s ${SPRING_APPS_SERVICE} -n weatherforecast

# Bind app to Application Configuration Service
az spring application-configuration-service bind -g ${RESOURCE_GROUP} -s ${SPRING_APPS_SERVICE} --app weatherforecast

# Bind app to service registry
az spring service-registry bind -g ${RESOURCE_GROUP} -s ${SPRING_APPS_SERVICE} --app weatherforecast

# Clean all files generated by dotnet
dotnet clean

# Deploy pre-built binary to an app 
az spring app deploy -g ${RESOURCE_GROUP} -s ${SPRING_APPS_SERVICE} -n weatherforecast --source-path . --config-file-patterns weatherforecast
```

## Enterprise pricing plan with your container registry

Script below demonstrates how to deploy application with an image built locally and stored in Azure Container Registry. You need to create an Azure Container Registry ahead and add the name of your container registry to variable.  

```bash
# Clean all files generated by dotnet
dotnet clean

# Build image
docker build -t ${CONTAINER_REGISTRY}.azurecr.io/weatherforecast -f Dockerfile .

# Verify it locally (optional)
docker run -p 8080:8080 ${CONTAINER_REGISTRY}.azurecr.io/

az acr login --name ${CONTAINER_REGISTRY}

docker push ${CONTAINER_REGISTRY}.azurecr.io/weatherforecast

az spring app deploy -g ${RESOURCE_GROUP} -s ${SPRING_APPS_SERVICE} -n weatherforecast --container-image weatherforecast --container-registry ${CONTAINER_REGISTRY}.azurecr.io --registry-username $(az acr credential show --name ${CONTAINER_REGISTRY} --query 'username' -o tsv) --registry-password $(az acr credential show --name ${CONTAINER_REGISTRY} --query 'passwords[0].value' -o tsv) --env eureka.client.service-url.defaultZone=https://${SPRING_APPS_SERVICE}.svc.azuremicroservices.io/eureka/default/eureka eureka_client_tls_keystore=file:///etc/azure-spring-cloud/certs/service-runtime-client-cert.p12 eureka_client_tls_enabled=true eureka_client_tls_keystoretype=PKCS12
```

## Get log of app execution

```bash
az spring app logs -g ${RESOURCE_GROUP} -s ${SPRING_APPS_SERVICE} -n weatherforecast --lines 1000
```

# Changes in sample project
